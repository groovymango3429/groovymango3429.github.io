<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clemson Class Scheduler</title>
    
    <!-- Google tag (gtag.js) tester -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8HVXCYQ4RL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8HVXCYQ4RL');
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f56600 0%, #522d80 100%);
            min-height: 100vh;
            padding: 1rem;
            position: relative;
        }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 3rem; }
        .main-card {
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
            border-bottom: 3px solid #f56600;
            padding-bottom: 1.5rem;
        }
        h1 { color: #f56600; font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { color: #522d80; font-size: 1rem; font-weight: 600; }
        .term-badge {
            background: linear-gradient(135deg, #f56600 0%, #522d80 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            font-size: 1rem;
        }
        .visitor-counter {
            background: linear-gradient(135deg, #fff7ed 0%, #f5f3ff 100%);
            border-left: 4px solid #f56600;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }
        .visitor-counter i {
            color: #f56600;
            font-size: 1.25rem;
        }
        .visitor-counter .count {
            font-weight: 700;
            color: #522d80;
            font-size: 1.1rem;
        }
        .visitor-counter .text {
            color: #6b7280;
        }
        .section { margin-bottom: 2rem; }
        .section-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 1rem; gap: 1rem;
        }
        h3 { font-size: 1.25rem; color: #522d80; margin-bottom: 0.5rem; }
        .helper-text { font-size: 0.875rem; color: #6b7280; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: #522d80; margin-bottom: 0.5rem; }
        .input-group { display: flex; gap: 0.5rem; }
        input[type="text"], select {
            flex: 1; padding: 0.75rem 1rem; border: 2px solid #d1d5db;
            font-size: 1rem; transition: all 0.2s;
        }
        input[type="text"]:focus, select:focus {
            outline: none; border-color: #f56600; box-shadow: 0 0 0 3px rgba(245, 102, 0, 0.1);
        }
        .checkbox-group {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-item input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            accent-color: #f56600;
        }
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 1rem;
            color: #1f2937;
        }
        .special-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
        .badge-honors {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-rise {
            background: #dbeafe;
            color: #1e40af;
        }
        .btn-primary {
            background: #f56600; color: white; border: none;
            padding: 0.75rem 1.5rem; font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary:hover { background: #d45500; }
        .btn-secondary {
            background: #522d80; color: white; border: none;
            padding: 0.5rem 1rem; font-size: 0.875rem;
            font-weight: 600; cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-secondary:hover { background: #3d2160; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-generate {
            width: 100%; background: linear-gradient(135deg, #f56600 0%, #522d80 100%);
            color: white; border: none; padding: 1rem;
            font-size: 1.125rem; font-weight: 700; cursor: pointer;
            transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.75rem;
        }
        .btn-generate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(245, 102, 0, 0.4); }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-load-more {
            width: 100%;
            background: linear-gradient(135deg, #522d80 0%, #f56600 100%);
            color: white;
            border: none;
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 2rem;
            box-shadow: 0 4px 15px rgba(82, 45, 128, 0.3);
        }
        .btn-load-more:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(82, 45, 128, 0.5);
        }
        .btn-load-more:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .course-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .course-tag {
            background: #f56600; color: white; padding: 0.5rem 1rem;
            display: flex; align-items: center; gap: 0.5rem; font-weight: 500;
        }
        .course-tag button {
            background: none; border: none; color: white; cursor: pointer; padding: 0.25rem;
            transition: background 0.2s;
        }
        .course-tag button:hover { background: rgba(255, 255, 255, 0.2); }
        .linked-group {
            background: #f5f3ff; border: 2px solid #522d80;
            padding: 1rem; margin-bottom: 1rem;
        }
        .linked-group-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
        }
        .linked-group-title {
            display: flex; align-items: center; gap: 0.5rem; color: #522d80; font-weight: 500;
        }
        .linked-group-remove {
            background: none; border: none; color: #dc2626; cursor: pointer; padding: 0.25rem;
            transition: background 0.2s;
        }
        .linked-group-remove:hover { background: #fee2e2; }
        .linked-courses { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .linked-course-tag {
            background: white; color: #522d80; padding: 0.25rem 0.75rem;
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; border: 1px solid #522d80;
        }
        .linked-course-tag button {
            background: none; border: none; color: #522d80; cursor: pointer; padding: 0.125rem; transition: background 0.2s;
        }
        .linked-course-tag button:hover { background: #f5f3ff; }
        .schedule-types {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;
        }
        .schedule-type {
            background: white; border: 2px solid #e5e7eb; padding: 1rem;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .schedule-type:hover { border-color: #f56600; }
        .schedule-type.active { border-color: #f56600; background: #fff7ed; }
        .schedule-type .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .schedule-type .label { font-weight: 600; color: #522d80; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .schedule-type .desc { font-size: 0.7rem; color: #6b7280; }
        .schedule-card {
            background: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 1.5rem; margin-bottom: 1.5rem; border-top: 4px solid #f56600;
        }
        .schedule-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;
        }
        .schedule-info { display: flex; align-items: center; gap: 1rem; }
        .score-badge {
            padding: 0.5rem 1rem; font-weight: 700;
        }
        .score-high { background: #d1fae5; color: #065f46; }
        .score-medium { background: #fef3c7; color: #92400e; }
        .score-low { background: #fee2e2; color: #991b1b; }
        .btn-export {
            background: #522d80; color: white; border: none; padding: 0.5rem 1rem;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;
        }
        .btn-export:hover { background: #3d2160; }
        .btn-toggle {
            background: #f56600; color: white; border: none; padding: 0.5rem 1rem;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;
        }
        .btn-toggle:hover { background: #d45500; }
        
        /* Calendar Styles */
        .calendar-container {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            min-height: 500px;
        }
        .time-column {
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
        }
        .time-slot {
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }
        .day-column {
            border-right: 1px solid #e5e7eb;
            position: relative;
            background: #fafafa;
        }
        .day-column:last-child {
            border-right: none;
        }
        .day-header {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #522d80;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .time-grid {
            position: relative;
            height: 100%;
        }
        .time-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
        }
        .class-block {
            position: absolute;
            left: 4px;
            right: 4px;
            background: linear-gradient(135deg, #f56600 0%, #ff8534 100%);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(245, 102, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        .class-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 102, 0, 0.5);
            z-index: 20;
        }
        .class-block-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .class-block-time {
            font-size: 0.65rem;
            opacity: 0.9;
        }
        .class-block-location {
            font-size: 0.65rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        
        /* List View Styles */
        .list-view {
            display: none;
        }
        .list-view.active {
            display: block;
        }
        .class-section {
            border: 2px solid #e5e7eb; padding: 1rem; margin-bottom: 1rem;
            transition: all 0.2s;
        }
        .class-section:hover { box-shadow: 0 4px 12px rgba(245, 102, 0, 0.2); border-color: #f56600; }
        .class-header {
            display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;
        }
        .class-title { font-size: 1.125rem; font-weight: 600; color: #522d80; }
        .crn-badge {
            background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem; font-size: 0.75rem;
        }
        .class-name { color: #6b7280; margin-bottom: 1rem; }
        .class-details {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.875rem;
        }
        .detail-item { display: flex; align-items: center; gap: 0.5rem; color: #4b5563; }
        .detail-icon { width: 1rem; height: 1rem; }
        
        .ready-card {
            background: linear-gradient(135deg, #fff7ed 0%, #f5f3ff 100%); 
            border: 3px solid #f56600; 
            padding: 2rem; 
            text-align: center;
        }
        .ready-card i { font-size: 3rem; color: #f56600; margin-bottom: 1rem; }
        .ready-card h3 { color: #522d80; margin-bottom: 0.5rem; }
        .ready-card p { color: #f56600; font-weight: 600; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(82, 45, 128, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .spinner {
            width: 3rem; height: 3rem; border: 4px solid rgba(245, 102, 0, 0.3);
            border-top-color: #f56600; animation: spin 1s linear infinite; border-radius: 50%;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay p { 
            color: white; 
            font-size: 1.25rem; 
            font-weight: 600; 
            margin-top: 1rem; 
        }
        .loading-progress {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }
        .hidden { display: none !important; }
        #schedulesSection h2 { font-size: 1.75rem; color: white; margin-bottom: 1.5rem; text-align: center; }
        .credit {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.95);
            color: #522d80;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #f56600;
            z-index: 999;
        }
        .credit i {
            color: #f56600;
            margin-right: 0.5rem;
        }
        .dev-notice {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: rgba(255, 247, 237, 0.98);
            color: #92400e;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #f59e0b;
            z-index: 999;
            max-width: 350px;
            border-radius: 0 4px 4px 0;
        }
        .dev-notice i {
            color: #f59e0b;
            margin-right: 0.5rem;
        }
        .dev-notice strong {
            color: #78350f;
            display: block;
            margin-bottom: 0.25rem;
        }
        .dev-notice a {
            color: #f56600;
            text-decoration: none;
            font-weight: 600;
        }
        .dev-notice a:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .main-card { padding: 1.5rem; }
            h1 { font-size: 1.5rem; }
            .header { flex-direction: column; }
            .schedule-types { grid-template-columns: repeat(2, 1fr); }
            .input-group { flex-direction: column; }
            .section-header { flex-direction: column; align-items: flex-start; }
            .schedule-header { flex-direction: column; align-items: flex-start; }
            .calendar-grid {
                grid-template-columns: 50px repeat(5, 1fr);
                font-size: 0.75rem;
            }
            .time-slot {
                height: 50px;
                font-size: 0.65rem;
            }
            .time-grid-line {
                height: 50px;
            }
            .class-block {
                font-size: 0.65rem;
                padding: 0.25rem;
            }
            .credit, .dev-notice {
                position: static;
                margin: 1rem auto;
                text-align: center;
                max-width: 100%;
            }
            .dev-notice {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="header">
                <div>
                    <h1>üêÖ Clemson Class Scheduler</h1>
                    <p class="subtitle">Find your perfect class schedule</p>
                </div>
                <div class="term-badge">
                    Spring 2026
                </div>
            </div>
            
            <div class="visitor-counter">
                <i class="fas fa-users"></i>
                <span class="text">
                    <span class="count" id="visitorCount">Loading...</span> 
                    Clemson students have generated a schedule
                </span>
            </div>
            
            <div style="background: linear-gradient(135deg, #fff7ed 0%, #f5f3ff 100%); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border-left: 4px solid #f56600;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-star" style="color: #f56600;"></i>
                    <strong style="color: #522d80; font-size: 1rem;">New Features:</strong>
                </div>
                <ul style="margin-left: 1.5rem; color: #4b5563; font-size: 0.875rem; line-height: 1.6;">
                    <li><strong>Professor Selection:</strong> Choose your preferred professor for each class or leave as "Any Professor"</li>
                    <li><strong>Credit Hour Tracking:</strong> See total credit hours for your selected courses and in each schedule</li>
                    <li><strong>Smart Filtering:</strong> Schedules automatically filter to your professor preferences</li>
                </ul>
            </div>
            
            <div class="section">
                <label>Special Programs</label>
                <p class="helper-text" style="margin-bottom: 0.5rem;">Select if you're part of these programs to access exclusive sections</p>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="honorsCheckbox">
                        <label for="honorsCheckbox">üéì Honors Program</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="riseCheckbox">
                        <label for="riseCheckbox">üöÄ RiSE Program</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <label for="courseInput">Add Courses</label>
                <div class="input-group">
                    <input type="text" id="courseInput" placeholder="e.g., ENGR 1410 or MATH 1060 then click add">
                    <button id="addCourseBtn" class="btn-primary">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </div>
            <div id="selectedCoursesSection" class="section hidden">
                <h3>Selected Courses</h3>
                <p class="helper-text" style="margin-bottom: 1rem;">üí° After adding courses, select a preferred professor for each class or leave as "Any Professor" to see all options</p>
                <div id="selectedCoursesList" class="course-tags"></div>
            </div>
            <div class="section">
                <div class="section-header">
                    <div>
                        <h3>Linked Courses</h3>
                        <p class="helper-text">Courses that must have matching section numbers (add all classes, then do this)</p>
                    </div>
                    <button id="addLinkBtn" class="btn-secondary">
                        <i class="fas fa-link"></i> Add Link Group
                    </button>
                </div>
                <div id="linkedCoursesList"></div>
            </div>
            <div class="section">
                <label>Schedule Preference</label>
                <div class="schedule-types">
                    <button class="schedule-type active" data-type="balanced">
                        <div class="icon">‚öñÔ∏è</div>
                        <div class="label">Balanced</div>
                        <div class="desc">Even spread throughout day</div>
                    </button>
                    <button class="schedule-type" data-type="early">
                        <div class="icon">üåÖ</div>
                        <div class="label">Early Bird</div>
                        <div class="desc">8 AM starts, done early</div>
                    </button>
                    <button class="schedule-type" data-type="late">
                        <div class="icon">üåô</div>
                        <div class="label">Night Owl</div>
                        <div class="desc">Start later in day</div>
                    </button>
                    <button class="schedule-type" data-type="compact">
                        <div class="icon">‚ö°</div>
                        <div class="label">Compact</div>
                        <div class="desc">Minimize gaps</div>
                    </button>
                    <button class="schedule-type" data-type="mwf">
                        <div class="icon">üìÖ</div>
                        <div class="label">MWF Focus</div>
                        <div class="desc">Mon/Wed/Fri preferred</div>
                    </button>
                    <button class="schedule-type" data-type="tr">
                        <div class="icon">üìÜ</div>
                        <div class="label">T/R Focus</div>
                        <div class="desc">Tue/Thu preferred</div>
                    </button>
                    <button class="schedule-type" data-type="no-friday">
                        <div class="icon">üéâ</div>
                        <div class="label">No Friday</div>
                        <div class="desc">Keep Fridays free</div>
                    </button>
                    <button class="schedule-type" data-type="long-lunch">
                        <div class="icon">üçΩÔ∏è</div>
                        <div class="label">Lunch Break</div>
                        <div class="desc">Gap 12-2 PM</div>
                    </button>
                    <button class="schedule-type" data-type="three-day">
                        <div class="icon">üóìÔ∏è</div>
                        <div class="label">3-Day Week</div>
                        <div class="desc">Classes 3 days only</div>
                    </button>
                </div>
            </div>
            <button id="generateBtn" class="btn-generate" disabled>
                <i class="fas fa-calendar-alt"></i> Generate Schedules
            </button>
        </div>
        <div id="schedulesSection" class="hidden">
            <h2>Generated Schedules</h2>
            <div id="schedulesList"></div>
            <button id="loadMoreBtn" class="btn-load-more">
                <i class="fas fa-plus-circle"></i> Generate More Schedules
            </button>
        </div>
        <div id="readySection" class="ready-card hidden">
            <i class="fas fa-info-circle"></i>
            <h3>Ready to Generate</h3>
            <p>Click "Generate Schedules" to find your optimal class schedule!</p>
        </div>
    </div>
    
    <div class="dev-notice">
        <div>
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Beta Version</strong>
        </div>
        <div>
            Site is still in development. Found a bug or have a suggestion? Email: <a href="mailto:pwrigh3@clemson.edu">pwrigh3@clemson.edu</a>
        </div>
    </div>
    
    <div class="credit">
        <i class="fas fa-code"></i> Created by Patty and Tris
    </div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p id="loadingText">Generating Schedules...</p>
        <p class="loading-progress" id="loadingProgress"></p>
    </div>
    <script>
    let selectedCourses = [];
    let linkedCourses = [];
    let scheduleType = 'balanced';
    let generatedSchedules = [];
    let allSchedulesPool = [];
    let allCoursesData = [];
    let isHonors = false;
    let isRise = false;
    let currentDisplayCount = 20;
    const SCHEDULES_PER_LOAD = 10;
    let professorPreferences = {}; // Maps courseCode -> preferred professor name (or null for any)
    
    const courseInput = document.getElementById('courseInput');
    const addCourseBtn = document.getElementById('addCourseBtn');
    const selectedCoursesSection = document.getElementById('selectedCoursesSection');
    const selectedCoursesList = document.getElementById('selectedCoursesList');
    const addLinkBtn = document.getElementById('addLinkBtn');
    const linkedCoursesList = document.getElementById('linkedCoursesList');
    const scheduleTypes = document.querySelectorAll('.schedule-type');
    const generateBtn = document.getElementById('generateBtn');
    const schedulesSection = document.getElementById('schedulesSection');
    const schedulesList = document.getElementById('schedulesList');
    const readySection = document.getElementById('readySection');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const loadingProgress = document.getElementById('loadingProgress');
    const honorsCheckbox = document.getElementById('honorsCheckbox');
    const riseCheckbox = document.getElementById('riseCheckbox');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    function loadVisitorCount() {
        const STORAGE_KEY = 'cuSchedulerCount';
        const BASE_COUNT = 147;
        const lastVisit = sessionStorage.getItem('cuSchedulerVisited');
        
        if (!lastVisit) {
            let currentCount = parseInt(localStorage.getItem(STORAGE_KEY) || BASE_COUNT);
            currentCount++;
            localStorage.setItem(STORAGE_KEY, currentCount);
            sessionStorage.setItem('cuSchedulerVisited', 'true');
        }
        
        const displayCount = parseInt(localStorage.getItem(STORAGE_KEY) || BASE_COUNT);
        document.getElementById('visitorCount').textContent = displayCount;
    }
    
    function incrementScheduleCount() {
        const STORAGE_KEY = 'cuSchedulerCount';
        const BASE_COUNT = 147;
        
        let currentCount = parseInt(localStorage.getItem(STORAGE_KEY) || BASE_COUNT);
        currentCount++;
        localStorage.setItem(STORAGE_KEY, currentCount);
        document.getElementById('visitorCount').textContent = currentCount;
    }
    
    loadVisitorCount();
    
    async function loadCoursesData() {
        try {
            const response = await fetch('course_schedule_2026.json');
            if (!response.ok) throw new Error('Failed to fetch courses');
            const data = await response.json();
            allCoursesData = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading courses:', error);
            alert('Failed to load course data. Please ensure course_schedule_2026.json is in the same folder as index.html.');
            allCoursesData = [];
        }
        updateGenerateButton();
    }
    
    loadCoursesData();
    
    honorsCheckbox.addEventListener('change', (e) => {
        isHonors = e.target.checked;
        resetSchedules();
    });
    
    riseCheckbox.addEventListener('change', (e) => {
        isRise = e.target.checked;
        resetSchedules();
    });
    
    addCourseBtn.addEventListener('click', () => addCourse());
    courseInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCourse(); });
    addLinkBtn.addEventListener('click', addLinkedGroup);
    scheduleTypes.forEach(btn => {
        btn.addEventListener('click', () => {
            scheduleTypes.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            scheduleType = btn.dataset.type;
            resetSchedules();
        });
    });
    generateBtn.addEventListener('click', generateSchedules);
    loadMoreBtn.addEventListener('click', loadMoreSchedules);
    
    function resetSchedules() {
        generatedSchedules = [];
        allSchedulesPool = [];
        currentDisplayCount = 20;
        schedulesSection.classList.add('hidden');
        updateLoadMoreButton();
    }
    
    function updateLoadMoreButton() {
        if (allSchedulesPool.length === 0) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Generate More Schedules';
        } else if (currentDisplayCount >= allSchedulesPool.length) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<i class="fas fa-check-circle"></i> All Schedules Displayed';
        } else {
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = `<i class="fas fa-plus-circle"></i> Generate More Schedules (${allSchedulesPool.length - currentDisplayCount} remaining)`;
        }
    }
    
    function hasAttribute(section, attributeCode) {
        if (!section.sectionAttributes || !Array.isArray(section.sectionAttributes)) return false;
        return section.sectionAttributes.some(attr => attr.code === attributeCode);
    }
    
    function isRiseOnly(section) {
        return section.courseTitle && section.courseTitle.includes("RiSE Only");
    }
    
    function canEnrollInSection(section) {
        const hasHonorsAttr = hasAttribute(section, 'HONR');
        const isRiseSection = isRiseOnly(section);
        
        if (hasHonorsAttr && !isHonors) return false;
        if (isRiseSection && !isRise) return false;
        
        return true;
    }
    
    function validateCourse(courseCode) {
        const parts = courseCode.trim().split(/\s+/);
        if (parts.length !== 2) return null;
        const subject = parts[0].toUpperCase();
        const courseNumber = parts[1];
        const matches = allCoursesData.filter(course => 
            course.subject === subject && 
            course.courseNumber === courseNumber &&
            canEnrollInSection(course)
        );
        return matches.length > 0 ? { subject, courseNumber, matches } : null;
    }
    
    function addCourse() {
        const courseCode = courseInput.value.trim().toUpperCase();
        if (!courseCode) return;
        const validation = validateCourse(courseCode);
        if (!validation) {
            alert(`Course "${courseCode}" not found in the Spring 2026 catalog or you don't have access to it. Check if you need to select Honors or RiSE programs.`);
            return;
        }
        const formattedCode = `${validation.subject} ${validation.courseNumber}`;
        if (!selectedCourses.includes(formattedCode)) {
            selectedCourses.push(formattedCode);
            courseInput.value = '';
            renderSelectedCourses();
            updateGenerateButton();
            resetSchedules();
        } else {
            alert(`Course "${formattedCode}" is already added.`);
        }
    }
    
    function removeCourse(course) {
        selectedCourses = selectedCourses.filter(c => c !== course);
        linkedCourses = linkedCourses.filter(link => !link.courses.includes(course));
        delete professorPreferences[course]; // Remove professor preference
        renderSelectedCourses();
        renderLinkedCourses();
        updateGenerateButton();
        resetSchedules();
    }
    
    function getTotalCreditHours() {
        let totalCredits = 0;
        for (const courseCode of selectedCourses) {
            const parts = courseCode.split(' ');
            const subject = parts[0];
            const courseNumber = parts[1];
            const section = allCoursesData.find(course =>
                course.subject === subject &&
                course.courseNumber === courseNumber
            );
            if (section) {
                const credits = section.creditHourLow || section.creditHours || 0;
                totalCredits += credits;
            }
        }
        return totalCredits;
    }
    
    function getProfessorsForCourse(courseCode) {
        const parts = courseCode.split(' ');
        const subject = parts[0];
        const courseNumber = parts[1];
        const sections = allCoursesData.filter(course =>
            course.subject === subject &&
            course.courseNumber === courseNumber &&
            canEnrollInSection(course)
        );
        
        const professorSet = new Set();
        sections.forEach(section => {
            if (section.faculty && section.faculty.length > 0) {
                section.faculty.forEach(prof => {
                    if (prof.displayName && prof.displayName.trim() !== '') {
                        professorSet.add(prof.displayName);
                    }
                });
            }
        });
        
        return Array.from(professorSet).sort();
    }
    
    function setProfessorPreference(courseCode, professorName) {
        professorPreferences[courseCode] = professorName;
        resetSchedules();
    }
    
    function renderSelectedCourses() {
        if (selectedCourses.length === 0) {
            selectedCoursesSection.classList.add('hidden');
            return;
        }
        selectedCoursesSection.classList.remove('hidden');
        
        const totalCredits = getTotalCreditHours();
        
        selectedCoursesList.innerHTML = `
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f0f9ff; border-left: 4px solid #0ea5e9;">
                <strong style="color: #0369a1;">Total Credit Hours: ${totalCredits}</strong>
            </div>
            ${selectedCourses.map(course => {
                const professors = getProfessorsForCourse(course);
                const selectedProf = professorPreferences[course] || '';
                const parts = course.split(' ');
                const section = allCoursesData.find(c =>
                    c.subject === parts[0] &&
                    c.courseNumber === parts[1]
                );
                const credits = section ? (section.creditHourLow || section.creditHours || 0) : 0;
                
                return `
                    <div class="course-tag" style="flex-direction: column; align-items: flex-start; padding: 0.75rem; min-width: 300px;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600;">${course} <span style="opacity: 0.8; font-size: 0.875rem;">(${credits} hrs)</span></span>
                            <button onclick="removeCourse('${course}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        ${professors.length > 0 ? `
                            <div style="width: 100%; margin-top: 0.25rem;">
                                <label style="font-size: 0.75rem; color: white; opacity: 0.9; margin-bottom: 0.25rem; display: block;">
                                    <i class="fas fa-user"></i> Preferred Professor (optional):
                                </label>
                                <select onchange="setProfessorPreference('${course}', this.value)" 
                                        style="width: 100%; padding: 0.4rem; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.9);">
                                    <option value="">Any Professor</option>
                                    ${professors.map(prof => `
                                        <option value="${prof}" ${selectedProf === prof ? 'selected' : ''}>${prof}</option>
                                    `).join('')}
                                </select>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
        `;
    }
    
    function addLinkedGroup() {
        if (selectedCourses.length < 2) {
            alert('Please add at least 2 courses before creating a linked group.');
            return;
        }
        linkedCourses.push({ id: Date.now(), courses: [] });
        renderLinkedCourses();
    }
    
    function removeLinkedGroup(id) {
        linkedCourses = linkedCourses.filter(link => link.id !== id);
        renderLinkedCourses();
        resetSchedules();
    }
    
    function addCourseToLink(linkId, course) {
        const link = linkedCourses.find(l => l.id === linkId);
        if (link && !link.courses.includes(course)) {
            link.courses.push(course);
            renderLinkedCourses();
            resetSchedules();
        }
    }
    
    function removeCourseFromLink(linkId, course) {
        const link = linkedCourses.find(l => l.id === linkId);
        if (link) {
            link.courses = link.courses.filter(c => c !== course);
            renderLinkedCourses();
            resetSchedules();
        }
    }
    
    function renderLinkedCourses() {
        if (linkedCourses.length === 0) {
            linkedCoursesList.innerHTML = '';
            return;
        }
        linkedCoursesList.innerHTML = linkedCourses.map(link => {
            const availableCourses = selectedCourses.filter(c => !link.courses.includes(c));
            return `
                <div class="linked-group">
                    <div class="linked-group-header">
                        <div class="linked-group-title">
                            <i class="fas fa-link"></i>
                            <span>Must have same section number</span>
                        </div>
                        <button class="linked-group-remove" onclick="removeLinkedGroup(${link.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="linked-courses">
                        ${link.courses.map(course => `
                            <div class="linked-course-tag">
                                <span>${course}</span>
                                <button onclick="removeCourseFromLink(${link.id}, '${course}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <select onchange="handleLinkSelect(${link.id}, this.value); this.value='';">
                        <option value="">+ Add course to this link group</option>
                        ${availableCourses.map(course => `
                            <option value="${course}">${course}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }).join('');
    }
    
    function handleLinkSelect(linkId, course) {
        if (course) {
            addCourseToLink(linkId, course);
        }
    }
    
    function updateGenerateButton() {
        generateBtn.disabled = selectedCourses.length === 0 || allCoursesData.length === 0;
    }
    
    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const hour = parseInt(timeStr.substring(0, 2));
        const min = parseInt(timeStr.substring(2, 4));
        return hour * 60 + min;
    }
    
    function formatTime(timeStr) {
        if (!timeStr) return '';
        const hour = parseInt(timeStr.substring(0, 2));
        const min = timeStr.substring(2, 4);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        return `${displayHour}:${min} ${ampm}`;
    }
    
    function getDaysString(meeting) {
        if (!meeting) return '';
        const days = [];
        if (meeting.monday) days.push('M');
        if (meeting.tuesday) days.push('T');
        if (meeting.wednesday) days.push('W');
        if (meeting.thursday) days.push('R');
        if (meeting.friday) days.push('F');
        return days.join('');
    }
    
    function scoreSchedule(sections) {
        let score = 100;
        
        const meetings = sections
            .map(s => s.meetingsFaculty && s.meetingsFaculty[0]?.meetingTime)
            .filter(m => m && m.beginTime && m.endTime && parseTime(m.beginTime) > 0);
        
        if (meetings.length === 0) return 70;
        
        const times = meetings.map(m => parseTime(m.beginTime));
        const endTimes = meetings.map(m => parseTime(m.endTime));
        
        const earliestStart = Math.min(...times);
        const latestEnd = Math.max(...endTimes);
        const totalSpan = latestEnd - earliestStart;
        const totalClassTime = meetings.reduce((sum, m) => {
            return sum + (parseTime(m.endTime) - parseTime(m.beginTime));
        }, 0);
        const gapTime = totalSpan - totalClassTime;
        
        const mwfCount = meetings.filter(m => m.monday || m.wednesday || m.friday).length;
        const trCount = meetings.filter(m => m.tuesday || m.thursday).length;
        const hasFriday = meetings.some(m => m.friday);
        
        const uniqueDays = new Set();
        meetings.forEach(m => {
            if (m.monday) uniqueDays.add('M');
            if (m.tuesday) uniqueDays.add('T');
            if (m.wednesday) uniqueDays.add('W');
            if (m.thursday) uniqueDays.add('R');
            if (m.friday) uniqueDays.add('F');
        });
        const numDays = uniqueDays.size;
        
        const hasLunchGap = meetings.every(m => {
            const start = parseTime(m.beginTime);
            const end = parseTime(m.endTime);
            return (end <= 720) || (start >= 840);
        });
        
        if (scheduleType === 'early') {
            const eightAMCount = times.filter(t => t === 480).length;
            const totalClasses = times.length;
            
            if (eightAMCount === totalClasses) {
                score += 100;
            } else {
                score += eightAMCount * 40;
                const nonEightAMCount = totalClasses - eightAMCount;
                score -= nonEightAMCount * 25;
            }
            
            if (earliestStart === 480) score += 20;
            else if (earliestStart === 510) score += 10;
            else if (earliestStart > 540) score -= 40;
            
            if (latestEnd <= 720) score += 40;
            else if (latestEnd <= 780) score += 30;
            else if (latestEnd <= 840) score += 20;
            else if (latestEnd <= 900) score += 10;
            else if (latestEnd > 960) score -= 35;
            
            if (gapTime > 180) score -= 10;
            
        } else if (scheduleType === 'late') {
            if (earliestStart >= 720) score += 25;
            else if (earliestStart >= 660) score += 15;
            else if (earliestStart >= 600) score += 10;
            else if (earliestStart < 540) score -= 25;
            
            if (latestEnd <= 840) score -= 20;
            else if (latestEnd >= 960) score += 10;
            
        } else if (scheduleType === 'compact') {
            if (gapTime <= 30) score += 35;
            else if (gapTime <= 60) score += 28;
            else if (gapTime <= 90) score += 18;
            else if (gapTime <= 120) score += 8;
            else if (gapTime > 180) score -= 25;
            else if (gapTime > 240) score -= 35;
            
            if (totalSpan <= 240) score += 25;
            else if (totalSpan <= 300) score += 18;
            else if (totalSpan <= 360) score += 12;
            else if (totalSpan > 480) score -= 20;
            
        } else if (scheduleType === 'mwf') {
            const mwfRatio = meetings.length > 0 ? mwfCount / meetings.length : 0;
            score += mwfRatio * 45;
            
            if (trCount > mwfCount) score -= 30;
            else if (trCount > 0) score -= (trCount * 6);
            
            if (mwfCount === meetings.length) score += 20;
            
        } else if (scheduleType === 'tr') {
            const trRatio = meetings.length > 0 ? trCount / meetings.length : 0;
            score += trRatio * 45;
            
            if (mwfCount > trCount) score -= 30;
            else if (mwfCount > 0) score -= (mwfCount * 6);
            
            if (trCount === meetings.length) score += 20;
            if (!hasFriday) score += 12;
            
        } else if (scheduleType === 'no-friday') {
            if (!hasFriday) {
                score += 50;
                
                if (earliestStart === 480) score += 10;
                if (numDays === 4) score += 8;
                if (numDays === 3) score += 12;
                
                if (uniqueDays.has('T') && uniqueDays.has('R') && !uniqueDays.has('M')) score += 5;
                if (uniqueDays.has('M') && uniqueDays.has('W') && !uniqueDays.has('T')) score += 5;
            } else {
                const fridayCount = meetings.filter(m => m.friday).length;
                score -= (fridayCount * 20);
                
                const fridayTimes = meetings.filter(m => m.friday).map(m => parseTime(m.beginTime));
                const earliestFriday = fridayTimes.length > 0 ? Math.min(...fridayTimes) : 999;
                if (earliestFriday <= 540) score += 10;
            }
            
        } else if (scheduleType === 'long-lunch') {
            if (hasLunchGap) score += 40;
            else score -= 25;
            
            if (gapTime >= 120) score += 10;
            
        } else if (scheduleType === 'three-day') {
            if (numDays === 3) score += 50;
            else if (numDays === 4) score += 20;
            else if (numDays === 2) score += 30;
            else if (numDays === 5) score -= 30;
            
            if (numDays === 3) {
                if (uniqueDays.has('T') && uniqueDays.has('R')) score += 15;
                if (uniqueDays.has('M') && uniqueDays.has('W') && uniqueDays.has('F')) score += 15;
            }
            
        } else if (scheduleType === 'balanced') {
            if (earliestStart >= 480 && earliestStart <= 600) score += 15;
            else if (earliestStart < 420 || earliestStart > 720) score -= 15;
            
            if (latestEnd >= 840 && latestEnd <= 1020) score += 15;
            else if (latestEnd > 1080 || latestEnd < 780) score -= 15;
            
            if (gapTime >= 60 && gapTime <= 120) score += 12;
            else if (gapTime > 240) score -= 15;
            
            const dayDiversity = Math.min(mwfCount, 1) + Math.min(trCount, 1);
            if (dayDiversity === 2) score += 12;
        }
        
        if (!hasFriday && scheduleType !== 'mwf' && scheduleType !== 'no-friday' && meetings.length > 1) {
            score += 10;
        }
        
        if (scheduleType !== 'early' && earliestStart < 450) score -= 12;
        if (scheduleType !== 'late' && latestEnd > 1050) score -= 12;
        
        if (scheduleType !== 'compact' && scheduleType !== 'long-lunch' && gapTime >= 60 && gapTime <= 180) {
            score += 6;
        }
        
        return Math.max(0, Math.min(200, Math.round(score)));
    }
    
    function getScheduleHash(sections) {
        return sections
            .map(s => `${s.subject}-${s.courseNumber}-${s.sequenceNumber}`)
            .sort()
            .join('|');
    }
    
    function getScheduleDiversity(schedule, existingSchedules) {
        let diversityScore = 0;
        const meetings = schedule.sections
            .map(s => s.meetingsFaculty && s.meetingsFaculty[0]?.meetingTime)
            .filter(m => m && m.beginTime && m.endTime);
        
        const times = meetings.map(m => parseTime(m.beginTime));
        const earliestStart = times.length > 0 ? Math.min(...times) : 0;
        const endTimes = meetings.map(m => parseTime(m.endTime));
        const latestEnd = endTimes.length > 0 ? Math.max(...endTimes) : 0;
        
        const uniqueDays = new Set();
        meetings.forEach(m => {
            if (m.monday) uniqueDays.add('M');
            if (m.tuesday) uniqueDays.add('T');
            if (m.wednesday) uniqueDays.add('W');
            if (m.thursday) uniqueDays.add('R');
            if (m.friday) uniqueDays.add('F');
        });
        
        existingSchedules.forEach(existing => {
            const existingMeetings = existing.sections
                .map(s => s.meetingsFaculty && s.meetingsFaculty[0]?.meetingTime)
                .filter(m => m && m.beginTime && m.endTime);
            
            const existingTimes = existingMeetings.map(m => parseTime(m.beginTime));
            const existingEarliestStart = existingTimes.length > 0 ? Math.min(...existingTimes) : 0;
            
            const existingDays = new Set();
            existingMeetings.forEach(m => {
                if (m.monday) existingDays.add('M');
                if (m.tuesday) existingDays.add('T');
                if (m.wednesday) existingDays.add('W');
                if (m.thursday) existingDays.add('R');
                if (m.friday) existingDays.add('F');
            });
            
            if (Math.abs(earliestStart - existingEarliestStart) < 60) diversityScore -= 5;
            if (uniqueDays.size === existingDays.size) diversityScore -= 3;
            
            const matchingSections = schedule.sections.filter(s1 => 
                existing.sections.some(s2 => 
                    s1.subject === s2.subject && 
                    s1.courseNumber === s2.courseNumber && 
                    s1.sequenceNumber === s2.sequenceNumber
                )
            ).length;
            
            const matchRatio = matchingSections / schedule.sections.length;
            if (matchRatio > 0.7) diversityScore -= 15;
            else if (matchRatio > 0.5) diversityScore -= 8;
        });
        
        return diversityScore;
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    async function showLoadingProgress() {
        const messages = [
            "Analyzing course sections...",
            "Checking time conflicts...",
            "Calculating optimal schedules...",
            "Applying preferences...",
            "Scoring schedules..."
        ];
        
        for (let i = 0; i < messages.length; i++) {
            loadingProgress.textContent = messages[i];
            await sleep(250);
        }
    }
    
    async function generateSchedules() {
        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = 'Generating Schedules...';
        loadingProgress.textContent = 'Starting...';
        incrementScheduleCount();
        
        if (typeof gtag !== 'undefined') {
            gtag('event', 'generate_schedule', {
                'event_category': 'engagement',
                'event_label': 'Schedule Generated',
                'value': selectedCourses.length
            });
        }
        
        const progressPromise = showLoadingProgress();
        
        try {
            const courseSections = {};
            for (const courseCode of selectedCourses) {
                const parts = courseCode.split(' ');
                const subject = parts[0];
                const courseNumber = parts[1];
                let sections = allCoursesData.filter(course =>
                    course.subject === subject &&
                    course.courseNumber === courseNumber &&
                    canEnrollInSection(course)
                );
                
                // Filter by professor preference if specified
                const preferredProf = professorPreferences[courseCode];
                if (preferredProf) {
                    const filteredSections = sections.filter(section => {
                        if (section.faculty && section.faculty.length > 0) {
                            return section.faculty.some(prof => prof.displayName === preferredProf);
                        }
                        return false;
                    });
                    if (filteredSections.length > 0) {
                        sections = filteredSections;
                    }
                }
                
                if (sections.length === 0) {
                    await progressPromise;
                    alert(`No available sections found for ${courseCode}. Check if you need Honors or RiSE access, or try a different professor.`);
                    loadingOverlay.classList.add('hidden');
                    return;
                }
                courseSections[courseCode] = sections;
            }
            
            await sleep(100);
            
            const allSchedules = generateCombinations(courseSections);
            if (allSchedules.length === 0) {
                await progressPromise;
                alert('No valid schedules found. Try adjusting your course selections or preferences.');
                loadingOverlay.classList.add('hidden');
                return;
            }
            
            const uniqueSchedules = new Map();
            
            allSchedules.forEach(sections => {
                const hash = getScheduleHash(sections);
                if (!uniqueSchedules.has(hash)) {
                    uniqueSchedules.set(hash, sections);
                }
            });
            
            let scheduleArray = Array.from(uniqueSchedules.values());
            
            if (scheduleType === 'no-friday') {
                const fridayFreeSchedules = scheduleArray.filter(sections => {
                    const meetings = sections
                        .map(s => s.meetingsFaculty && s.meetingsFaculty[0]?.meetingTime)
                        .filter(m => m && m.beginTime && m.endTime);
                    return !meetings.some(m => m.friday);
                });
                
                if (fridayFreeSchedules.length >= 5) {
                    scheduleArray = fridayFreeSchedules;
                } else if (fridayFreeSchedules.length > 0) {
                    const fridayMinimizedSchedules = scheduleArray.filter(sections => {
                        const meetings = sections
                            .map(s => s.meetingsFaculty && s.meetingsFaculty[0]?.meetingTime)
                            .filter(m => m && m.beginTime && m.endTime);
                        const fridayCount = meetings.filter(m => m.friday).length;
                        return fridayCount <= 1;
                    });
                    
                    scheduleArray = [...fridayFreeSchedules, ...fridayMinimizedSchedules];
                }
            }
            
            if (scheduleType === 'early') {
                const all8AMSchedules = scheduleArray.filter(sections => {
                    const meetings = sections
                        .map(s => s.meetingsFaculty && s.meetingsFaculty[0]?.meetingTime)
                        .filter(m => m && m.beginTime && m.endTime && parseTime(m.beginTime) > 0);
                    
                    if (meetings.length === 0) return false;
                    
                    return meetings.every(m => parseTime(m.beginTime) === 480);
                });
                
                if (all8AMSchedules.length > 0) {
                    scheduleArray = all8AMSchedules.concat(
                        scheduleArray.filter(s => !all8AMSchedules.includes(s))
                    );
                }
            }
            
            let scoredSchedules = scheduleArray.map((sections, idx) => ({
                id: idx + 1,
                sections,
                score: scoreSchedule(sections),
                diversityScore: 0
            }));
            
            scoredSchedules.sort((a, b) => b.score - a.score);
            
            allSchedulesPool = [];
            for (const schedule of scoredSchedules) {
                const diversityScore = getScheduleDiversity(schedule, allSchedulesPool);
                schedule.diversityScore = diversityScore;
                schedule.finalScore = schedule.score + diversityScore;
                
                if (allSchedulesPool.length < 5 || diversityScore > -15) {
                    allSchedulesPool.push(schedule);
                }
            }
            
            allSchedulesPool.sort((a, b) => b.finalScore - a.finalScore);
            
            const maxScore = allSchedulesPool.length > 0 ? allSchedulesPool[0].finalScore : 100;
            allSchedulesPool = allSchedulesPool.map((schedule, idx) => ({
                ...schedule,
                displayScore: Math.round((schedule.finalScore / maxScore) * 100),
                id: idx + 1
            }));
            
            await progressPromise;
            await sleep(200);
            
            currentDisplayCount = 20;
            generatedSchedules = allSchedulesPool.slice(0, currentDisplayCount);
            
            loadingOverlay.classList.add('hidden');
            renderSchedules();
            updateLoadMoreButton();
        } catch (error) {
            console.error('Error generating schedules:', error);
            await progressPromise;
            alert('An error occurred while generating schedules. Please try again.');
            loadingOverlay.classList.add('hidden');
        }
    }
    
    async function loadMoreSchedules() {
        if (currentDisplayCount >= allSchedulesPool.length) return;
        
        loadMoreBtn.disabled = true;
        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = 'Generating More Schedules...';
        loadingProgress.textContent = 'Finding additional options...';
        
        await sleep(500);
        
        currentDisplayCount += SCHEDULES_PER_LOAD;
        generatedSchedules = allSchedulesPool.slice(0, currentDisplayCount);
        
        loadingOverlay.classList.add('hidden');
        renderSchedules();
        updateLoadMoreButton();
    }
    
    function generateCombinations(courseSections) {
        const courseKeys = Object.keys(courseSections);
        const combinations = [];
        const maxCombinations = 20000;
        
        function backtrack(index, currentSchedule) {
            if (index === courseKeys.length) {
                if (isValidLinkedSchedule(currentSchedule)) {
                    combinations.push([...currentSchedule]);
                }
                return;            }
            const courseKey = courseKeys[index];
            const sections = courseSections[courseKey];
            for (const section of sections) {
                if (!hasTimeConflict(currentSchedule, section)) {
                    currentSchedule.push(section);
                    backtrack(index + 1, currentSchedule);
                    currentSchedule.pop();
                }
                if (combinations.length >= maxCombinations) return;
            }
        }
        backtrack(0, []);
        return combinations;
    }
    
    function hasTimeConflict(schedule, newSection) {
        const newMeeting = newSection.meetingsFaculty && newSection.meetingsFaculty[0]?.meetingTime;
        if (!newMeeting || !newMeeting.beginTime || !newMeeting.endTime) return false;
        
        const newStart = parseTime(newMeeting.beginTime);
        const newEnd = parseTime(newMeeting.endTime);
        if (newStart === 0 || newEnd === 0) return false;
        
        for (const section of schedule) {
            const meeting = section.meetingsFaculty && section.meetingsFaculty[0]?.meetingTime;
            if (!meeting || !meeting.beginTime || !meeting.endTime) continue;
            
            const start = parseTime(meeting.beginTime);
            const end = parseTime(meeting.endTime);
            if (start === 0 || end === 0) continue;
            
            const sharedDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].some(day => 
                meeting[day] && newMeeting[day]
            );
            
            if (sharedDays) {
                if ((start < newEnd && end > newStart)) {
                    return true;
                }
            }
        }
        return false;
    }
    
    function isValidLinkedSchedule(schedule) {
        if (linkedCourses.length === 0) return true;
        for (const link of linkedCourses) {
            if (link.courses.length < 2) continue;
            const sectionNumbers = link.courses.map(courseCode => {
                const section = schedule.find(s => `${s.subject} ${s.courseNumber}` === courseCode);
                return section ? section.sequenceNumber : null;
            });
            if (sectionNumbers.some(num => num === null)) continue;
            if (new Set(sectionNumbers).size > 1) return false;
        }
        return true;
    }
    
    function getSectionBadges(section) {
        const badges = [];
        if (hasAttribute(section, 'HONR')) {
            badges.push('<span class="special-badge badge-honors">HONORS</span>');
        }
        if (isRiseOnly(section)) {
            badges.push('<span class="special-badge badge-rise">RiSE</span>');
        }
        return badges.join('');
    }
    
    function toggleView(scheduleId) {
        const calendarView = document.getElementById(`calendar-${scheduleId}`);
        const listView = document.getElementById(`list-${scheduleId}`);
        const toggleBtn = document.getElementById(`toggle-${scheduleId}`);
        
        if (listView.classList.contains('active')) {
            listView.classList.remove('active');
            calendarView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-list"></i> Show Section Numbers';
        } else {
            listView.classList.add('active');
            calendarView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-calendar"></i> Show Calendar View';
        }
    }
    
    function renderCalendar(sections, scheduleId) {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const timeSlots = [];
        
        for (let hour = 7; hour <= 21; hour++) {
            const displayHour = hour > 12 ? hour - 12 : hour;
            const ampm = hour >= 12 ? 'PM' : 'AM';
            timeSlots.push({
                time: `${displayHour}:00 ${ampm}`,
                minutes: hour * 60
            });
        }
        
        let calendarHTML = '<div class="calendar-container"><div class="calendar-grid">';
        
        calendarHTML += '<div style="grid-column: 1; grid-row: 1; border-right: 2px solid #e5e7eb; background: white;"></div>';
        
        days.forEach((day, index) => {
            calendarHTML += `<div class="day-header" style="grid-column: ${index + 2}; grid-row: 1;">${day}</div>`;
        });
        
        timeSlots.forEach((slot, index) => {
            calendarHTML += `<div class="time-slot" style="grid-column: 1; grid-row: ${index + 2};">${slot.time}</div>`;
        });
        
        days.forEach((day, dayIndex) => {
            calendarHTML += `<div class="day-column" style="grid-column: ${dayIndex + 2}; grid-row: 2 / ${timeSlots.length + 2};">`;
            calendarHTML += '<div class="time-grid">';
            
            timeSlots.forEach((slot, index) => {
                calendarHTML += `<div class="time-grid-line" style="top: ${index * 60}px;"></div>`;
            });
            
            const dayName = day.toLowerCase();
            sections.forEach(section => {
                const meeting = section.meetingsFaculty && section.meetingsFaculty[0]?.meetingTime;
                if (!meeting || !meeting[dayName]) return;
                
                const startMinutes = parseTime(meeting.beginTime);
                const endMinutes = parseTime(meeting.endTime);
                
                const topPosition = (startMinutes - (7 * 60));
                const height = endMinutes - startMinutes;
                
                const courseCode = `${section.subject} ${section.courseNumber}`;
                const location = meeting.building && meeting.room ? `${meeting.building} ${meeting.room}` : 'TBA';
                
                calendarHTML += `
                    <div class="class-block" style="top: ${topPosition}px; height: ${height}px;" 
                         title="${section.courseTitle}&#10;${formatTime(meeting.beginTime)} - ${formatTime(meeting.endTime)}&#10;${location}">
                        <div class="class-block-title">${courseCode}</div>
                        <div class="class-block-time">${formatTime(meeting.beginTime)} - ${formatTime(meeting.endTime)}</div>
                        ${height > 60 ? `<div class="class-block-location">${location}</div>` : ''}
                    </div>
                `;
            });
            
            calendarHTML += '</div></div>';
        });
        
        calendarHTML += '</div></div>';
        return calendarHTML;
    }
    
    function renderSchedules() {
        if (generatedSchedules.length === 0) {
            schedulesSection.classList.add('hidden');
            readySection.classList.remove('hidden');
            return;
        }
        readySection.classList.add('hidden');
        schedulesSection.classList.remove('hidden');
        schedulesList.innerHTML = generatedSchedules.map(schedule => {
            const scoreToDisplay = schedule.displayScore || schedule.score;
            const scoreClass = scoreToDisplay >= 80 ? 'score-high' :
                              scoreToDisplay >= 60 ? 'score-medium' : 'score-low';
            
            // Calculate total credits for this schedule
            let totalCredits = 0;
            schedule.sections.forEach(section => {
                const credits = section.creditHourLow || section.creditHours || 0;
                totalCredits += credits;
            });
            
            // Check if any professor preferences were applied
            const appliedPreferences = [];
            schedule.sections.forEach(section => {
                const courseCode = `${section.subject} ${section.courseNumber}`;
                if (professorPreferences[courseCode] && section.faculty && section.faculty.length > 0) {
                    const profName = section.faculty[0].displayName;
                    if (profName === professorPreferences[courseCode]) {
                        appliedPreferences.push(`${courseCode}: ${profName}`);
                    }
                }
            });
            
            return `
                <div class="schedule-card">
                    <div class="schedule-header">
                        <div class="schedule-info">
                            <div class="score-badge ${scoreClass}">Score: ${scoreToDisplay}%</div>
                            <span style="color: #6b7280;">Schedule Option ${schedule.id}</span>
                            <span style="color: #0369a1; font-weight: 600; margin-left: 1rem;">üìö ${totalCredits} Credits</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-toggle" id="toggle-${schedule.id}" onclick="toggleView(${schedule.id})">
                                <i class="fas fa-list"></i> Show Section Numbers
                            </button>
                            <button class="btn-export" onclick="exportSchedule(${schedule.id})">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    ${appliedPreferences.length > 0 ? `
                        <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem;">
                            <strong style="color: #0369a1;"><i class="fas fa-check-circle"></i> Professor Preferences Applied:</strong>
                            <div style="margin-top: 0.25rem; color: #075985;">${appliedPreferences.join(' ‚Ä¢ ')}</div>
                        </div>
                    ` : ''}
                    
                    <div id="calendar-${schedule.id}">${renderCalendar(schedule.sections, schedule.id)}</div>
                    
                    <div id="list-${schedule.id}" class="list-view">
                        ${schedule.sections.map(section => {
                            const meeting = section.meetingsFaculty && section.meetingsFaculty[0]?.meetingTime;
                            const faculty = section.faculty && section.faculty[0];
                            return `
                                <div class="class-section">
                                    <div class="class-header">
                                        <span class="class-title">${section.subject} ${section.courseNumber}-${section.sequenceNumber}</span>
                                        <span class="crn-badge">CRN: ${section.courseReferenceNumber}</span>
                                        ${getSectionBadges(section)}
                                    </div>
                                    <div class="class-name">${section.courseTitle}</div>
                                    <div class="class-details">
                                        ${meeting ? `
                                            <div class="detail-item">
                                                <i class="fas fa-clock detail-icon"></i>
                                                <span>${getDaysString(meeting)} ${formatTime(meeting.beginTime)} - ${formatTime(meeting.endTime)}</span>
                                            </div>
                                            <div class="detail-item">
                                                <i class="fas fa-map-marker-alt detail-icon"></i>
                                                <span>${meeting.building} ${meeting.room}</span>
                                            </div>
                                        ` : '<div class="detail-item">Time: TBA</div>'}
                                        ${faculty ? `
                                            <div class="detail-item">
                                                <i class="fas fa-user detail-icon"></i>
                                                <span>${faculty.displayName}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');
        
        schedulesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function exportSchedule(scheduleId) {
        const schedule = generatedSchedules.find(s => s.id === scheduleId);
        if (!schedule) return;
        
        if (typeof gtag !== 'undefined') {
            gtag('event', 'export_schedule', {
                'event_category': 'engagement',
                'event_label': `Schedule ${scheduleId}`,
                'value': schedule.displayScore || schedule.score
            });
        }
        
        const scoreToDisplay = schedule.displayScore || schedule.score;
        
        // Calculate total credits
        let totalCredits = 0;
        schedule.sections.forEach(section => {
            const credits = section.creditHourLow || section.creditHours || 0;
            totalCredits += credits;
        });
        
        const text = `Clemson Schedule ${scheduleId} - Score: ${scoreToDisplay}%\nSpring 2026\nTotal Credits: ${totalCredits}\n\n` +
            schedule.sections.map(section => {
                const meeting = section.meetingsFaculty && section.meetingsFaculty[0]?.meetingTime;
                const faculty = section.faculty && section.faculty[0];
                const badges = [];
                if (hasAttribute(section, 'HONR')) badges.push('[HONORS]');
                if (isRiseOnly(section)) badges.push('[RiSE]');
                const credits = section.creditHourLow || section.creditHours || 0;
                return `${section.subject} ${section.courseNumber}-${section.sequenceNumber} (${credits} hrs) ${badges.join(' ')}\n${section.courseTitle}\n` +
                    `CRN: ${section.courseReferenceNumber}\n` +
                    (meeting ? `Time: ${getDaysString(meeting)} ${formatTime(meeting.beginTime)} - ${formatTime(meeting.endTime)}\n` +
                    `Location: ${meeting.building} ${meeting.room}\n` : 'Time: TBA\n') +
                    (faculty ? `Instructor: ${faculty.displayName}\n` : '') + '\n';
            }).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `clemson-schedule-${scheduleId}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }
    </script>
</body>
</html>